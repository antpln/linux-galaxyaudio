name: Build Kernel

on:
  schedule:
    - cron: '0 6 * * *'
  push:
    branches: [main]
    paths: [PKGBUILD, config, .github/workflows/build.yml]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force build even if version matches'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    
    steps:
      - name: Install dependencies
        run: pacman -Syu --noconfirm --overwrite '*' git bc kmod libelf cpio perl tar xz python pahole pacman-contrib curl github-cli sudo ccache
          
      - uses: actions/checkout@v4
      
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: kmod-ccache-${{ runner.os }}-${{ inputs.force }}-${{ github.run_id }}
          restore-keys: |
            kmod-ccache-${{ runner.os }}-
      
      - name: Check and build
        id: build-kernel
        env:
          GH_TOKEN: ${{ github.token }}
          CCACHE_DIR: ${{ github.workspace }}/.ccache
        run: |
          # Enable ccache
          sed -i 's/!ccache/ccache/g' /etc/makepkg.conf
          # Create and persist a MAKEFLAGS variable using nproc
          echo "MAKEFLAGS=\"-j\$(nproc)\"" >> /etc/makepkg.conf
          export CCACHE_DIR="${PWD}/.ccache"
          mkdir -p "$CCACHE_DIR"
          ccache -M 5G
          

          set -e
          
          echo "Disk space before build:"
          df -h .
          
          # Get Arch kernel version from package page (more reliable than JSON API)
          # The package page shows "Version: X.X.X.archX-X" 
          ARCH_VER=$(curl -sL "https://archlinux.org/packages/core/x86_64/linux/" | grep -oP 'linux \K[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          # Fallback: try the JSON API
          if [ -z "$ARCH_VER" ]; then
            ARCH_VER=$(curl -sL "https://archlinux.org/packages/core/x86_64/linux/json" | grep -oP '"pkgver":\s*"[^"]*"' | grep -oP '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          fi
          
          # Final fallback: use pacman
          if [ -z "$ARCH_VER" ]; then
            pacman -Sy --noconfirm
            ARCH_VER=$(pacman -Si linux 2>/dev/null | grep "^Version" | awk '{print $3}' | sed 's/\.arch.*//')
          fi
          
          if [ -z "$ARCH_VER" ]; then
            echo "ERROR: Could not determine Arch kernel version"
            exit 1
          fi
          
          CURRENT=$(grep "^pkgver=" PKGBUILD | cut -d= -f2)
          
          echo "Arch: $ARCH_VER | Current: $CURRENT"
          
          FORCE="${{ github.event.inputs.force }}"
          if [ "$ARCH_VER" = "$CURRENT" ] && [ "$FORCE" != "true" ]; then
            echo "Already up to date"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Updating to $ARCH_VER"
          
          # Update PKGBUILD
          sed -i "s/^pkgver=.*/pkgver=${ARCH_VER}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          
          # Verify
          grep "^pkgver=" PKGBUILD
          
          # Setup build user
          useradd builder -m
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          chown -R builder:builder .
          
          # Build
          su builder -c "updpkgsums"
          su builder -c "makepkg -s --noconfirm"
          su builder -c "makepkg --printsrcinfo > .SRCINFO"
          
          # ------------------------------------------------------------------
          # Prepare Binary Package Metadata (linux-galaxyaudio-bin)
          # ------------------------------------------------------------------
          cd linux-galaxyaudio-bin
          sed -i "s/^pkgver=.*/pkgver=${ARCH_VER}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          
          # Calculate Checksums from the just-built packages in ..
          SHA_BIN=$(sha256sum ../linux-galaxyaudio-${ARCH_VER}-1-x86_64.pkg.tar.zst | cut -d' ' -f1)
          SHA_HEADERS=$(sha256sum ../linux-galaxyaudio-headers-${ARCH_VER}-1-x86_64.pkg.tar.zst | cut -d' ' -f1)
          SHA_PRESET=$(sha256sum linux-galaxyaudio.preset | cut -d' ' -f1)
          
          sed -i "s/^sha256sums=.*/sha256sums=('${SHA_BIN}' '${SHA_HEADERS}' '${SHA_PRESET}')/" PKGBUILD
          
          # Generate .SRCINFO for binary package
          chown -R builder:builder .
          su builder -c "makepkg --printsrcinfo" > .SRCINFO
          
          echo "Generated linux-galaxyaudio-bin/.SRCINFO:"
          cat .SRCINFO
          cd ..
          
          # Commit
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$PWD"
          
          git add PKGBUILD .SRCINFO linux-galaxyaudio-bin/PKGBUILD linux-galaxyaudio-bin/.SRCINFO
          
          if [ -n "$(git status --porcelain PKGBUILD .SRCINFO linux-galaxyaudio-bin/PKGBUILD linux-galaxyaudio-bin/.SRCINFO)" ]; then
            git commit -m "Update to ${ARCH_VER}"
            git push
          else
            echo "No changes to PKGBUILD or .SRCINFO, skipping commit."
          fi
          
          echo "Disk space after build:"
          df -h .
          
          # Release
          # If forcing, or if the tag exists for some reason, delete it first to allow replacement
          if gh release view "v${ARCH_VER}" >/dev/null 2>&1; then
            echo "Release v${ARCH_VER} exists. Deleting..."
            gh release delete "v${ARCH_VER}" --cleanup-tag -y || true
          fi

          gh release create "v${ARCH_VER}" \
            --title "Linux ${ARCH_VER}" \
            --notes "Linux kernel ${ARCH_VER} with MAX98390 sound support for Samsung Galaxy Book." \
            *.pkg.tar.zst
          
          echo "status=built" >> $GITHUB_OUTPUT
          
      - name: Publish to AUR (bin)
        if: steps.build-kernel.outputs.status == 'built'
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: linux-galaxyaudio-bin
          pkgbuild: ./linux-galaxyaudio-bin/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to $(grep pkgver= PKGBUILD | cut -d= -f2)"
          assets: |
            linux-galaxyaudio-bin/PKGBUILD
            linux-galaxyaudio-bin/.SRCINFO
            linux-galaxyaudio-bin/linux-galaxyaudio-bin.install
